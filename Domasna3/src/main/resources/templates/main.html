<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issuer Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
            font-weight: bold;
        }

        tbody tr:hover {
            background-color: #f1f1f1;
        }

        #logout-btn {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        body > div > form > div:nth-child(4), body > div > form > div:nth-child(5) {
            margin-bottom: -33px;
        }
    </style>
</head>
<body>
<div class="container mt-5">

    <div class="text-end">
        <a href="/logout" id="logout-btn" class="btn btn-danger">Одјави се</a>
    </div>
</div>

<h1 class="header" th:text="${issuerCode}">Македонска берза</h1>

<div style="width: 80%; margin: auto;">
    <canvas id="TAStockChart"></canvas>

    <div class="timePeriodSelector">
        <label>Техничка анализа:
            <input type="radio" name="TATimePeriod" value="1_day" class="TAinput" onclick="updateTATimePeriod('1_day')">
            1 д.
        </label>
        <label>
            <input type="radio" name="TATimePeriod" value="1_week" class="TAinput"
                   onclick="updateTATimePeriod('1_week')">
            1 нед.
        </label>
        <label>
            <input type="radio" name="TATimePeriod" value="1_month" class="TAinput"
                   onclick="updateTATimePeriod('1_month')">
            1 м.
        </label>
    </div>
</div>


<form action="/issuers" method="post" class="row g-3 mb-4">
    <div class="col-lg-3 col-md-4 col-sm-12">
        <label for="code-select" class="form-label">Шифра:</label>
        <select id="code-select" name="code" class="form-select" required onchange="updateIssuer()">
            <option value="" selected disabled>-- Избери шифра --</option>
            <option th:each="code : ${codes}" th:value="${code}" th:text="${code}"
                    th:selected="${code == selectedCode}"></option>
        </select>
    </div>
    <div class="col-lg-3 col-md-4 col-sm-6">
        <label for="from-time" class="form-label">Од:</label>
        <input type="date" id="from-time" name="from" class="form-control" th:value="${selectedFrom}" required>
    </div>
    <div class="col-lg-3 col-md-4 col-sm-6">
        <label for="to-time" class="form-label">До:</label>
        <input type="date" id="to-time" name="to" class="form-control" th:value="${selectedTo}" required>
    </div>
    <div class="col-lg-3 col-md-12 col-sm-12 d-flex align-items-end">
        <button type="submit" class="btn btn-primary me-2">Прикажи</button>
        <button type="button" id="download-btn" class="btn btn-success me-2">Превземи</button>
    </div>
</form>

<div class="table-responsive mb-4">
    <table id="issuerTable" class="table table-bordered table-hover table-striped">
        <thead class="table-dark">
        <tr>
            <th>Датум</th>
            <th>Цена на последна трансакција</th>
            <th>Мак.</th>
            <th>Мин.</th>
            <th>Просечна цена</th>
            <th>%пром.</th>
            <th>Количина</th>
            <th>Промет во БЕСТ во денари</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="issuer : ${issuers}">
            <td th:text="${issuer.date}"></td>
            <td th:text="${issuer.lastTradePrice}"></td>
            <td th:text="${issuer.max}"></td>
            <td th:text="${issuer.min}"></td>
            <td th:text="${issuer.avgPrice}"></td>
            <td th:text="${issuer.percentageChange}"></td>
            <td th:text="${issuer.volume}"></td>
            <td th:text="${issuer.turnoverBest}"></td>
        </tr>
        </tbody>
    </table>
</div>
<div th:if="${issuers == null or issuers.isEmpty()}">
    <p>No issuers found for the specified criteria.</p>
</div>
</div>

<section id="charts">
    <div id="loading" style="text-align: center; margin: 20px;">
        <p>Loading charts...</p>
    </div>
    <canvas id="stockChartTotal" style="display: none;"></canvas>

    <div class="timePeriodSelector">
        <label>
            <input type="radio" name="timePeriod" value="1_month" class="input" onclick="updateTimePeriod('1_month')">
            1 м.
        </label>
        <label>
            <input type="radio" name="timePeriod" value="6_months" class="input" onclick="updateTimePeriod('6_months')">
            6 м.
        </label>
        <label>
            <input type="radio" name="timePeriod" value="1_year" class="input" onclick="updateTimePeriod('1_year')">
            1 год.
        </label>
        <label>
            <input type="radio" name="timePeriod" value="5_years" class="input" onclick="updateTimePeriod('5_years')">
            5 год.
        </label>
        <label>
            <input type="radio" name="timePeriod" value="all" class="input" onclick="updateTimePeriod('all')">
            10 год.
        </label>
    </div>
</section>
<div class="text-center mt-4">
    <a href="/comparison" class="btn btn-primary">Направи споредба</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

    let issuer = "";
    let checkedRadio = "";

    function updateIssuer() {
        const selectElement = document.getElementById('code-select');
        if (!selectElement.value) {
            console.log('No issuer selected. Aborting update.');
            return;
        }
        issuer = selectElement.value;
        console.log(`Issuer selected: ${issuer}`);
    }

    document.getElementById('download-btn').addEventListener('click', function () {
        var table = document.getElementById('issuerTable');
        var rows = table.getElementsByTagName('tr');
        var csvContent = '';

        for (var i = 1; i < rows.length; i++) {
            var rowData = [];
            var cols = rows[i].getElementsByTagName('td');

            for (var j = 0; j < cols.length; j++) {
                rowData.push(cols[j].innerText);
            }

            csvContent += rowData.join(',') + '\n';
        }

        var blob = new Blob([csvContent], {type: 'text/csv'});
        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'table_data.csv';
        link.click();
    });


    function updateTimePeriod(period) {
        const selectElement = document.getElementById('code-select');
        if (!selectElement.value) {
            console.log("No issuer selected. Aborting update.");
            return;
        }
        fetchStockChartTotalData(selectElement.value, period);
    }

    function fetchStockChartTotalData(issuer, timePeriod) {
        if (!issuer || !timePeriod) {
            console.log("Missing issuer or time period. Aborting fetch.");
            return;
        }
        const url = `/issuers/stock-chart-total-data?issuer=${encodeURIComponent(issuer)}&timePeriod=${encodeURIComponent(timePeriod)}`;
        const loadingDiv = document.getElementById('loading');
        loadingDiv.style.display = 'block';

        fetch(url)
            .then(response => response.json())
            .then(data => {
                loadingDiv.style.display = 'none';
                document.getElementById('stockChartTotal').style.display = 'block';
                updateStockChartTotal(data.periodDates, data.periodAvgPrices);
            })
            .catch(error => {
                console.error('Error fetching stock total chart data:', error);
                loadingDiv.innerHTML = '<p style="color: red;">Failed to load Total Stock Chart.</p>';
            });
    }

    function updateStockChartTotal(periodDates, periodAvgPrices) {
        const ctxTotal = document.getElementById('stockChartTotal').getContext('2d');
        if (window.stockChartTotal && typeof window.stockChartTotal.destroy === 'function') {
            window.stockChartTotal.destroy();
        }

        window.stockChartTotal = new Chart(ctxTotal, {
            type: 'line',
            data: {
                labels: periodDates,
                datasets: [{
                    label: 'Average Price (Total)',
                    data: periodAvgPrices,
                    borderColor: 'rgb(192,75,75)',
                    backgroundColor: 'rgba(192,75,128,0.2)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {responsive: true}
        });
    }

    function updateTATimePeriod(selectedTAPeriod) {
        TACheckedRadio = selectedTAPeriod;
        console.log(`TA Time Period selected: ${TACheckedRadio}`);

        const selectElement = document.getElementById('code-select');
        issuer = selectElement.value || issuer;

        if (issuer) {
            fetchTechnicalAnalysisData(issuer, TACheckedRadio);
        } else {
            console.log("No issuer selected. Cannot fetch TA data.");
        }
    }



    function fetchTechnicalAnalysisData(issuer, TACheckedRadio) {
        if (!issuer || !TACheckedRadio) {
            console.log("Missing issuer or TA time period. Aborting fetch.");
            return;
        }
        const url = `/issuers/technical-analysis?issuer=${encodeURIComponent(issuer)}&period=${encodeURIComponent(TACheckedRadio)}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                updateTechnicalAnalysisChart(data.prices, data.dates, data.buy, data.sell);
            })
            .catch(error => {
                console.error('Error fetching technical analysis data:', error);
            });
    }

    function updateTechnicalAnalysisChart(prices, dates, buy, sell) {
        const ctx = document.getElementById('TAStockChart').getContext('2d');

        if (window.TAStockChart && typeof window.TAStockChart.destroy === 'function') {
            window.TAStockChart.destroy();
        }

        window.TAStockChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'Stock Price',
                        data: prices,
                        borderColor: '#a172e2',
                        backgroundColor: 'rgba(0, 0, 255, 0.2)',
                        fill: true,
                        borderWidth: 1,
                    },
                    {
                        label: 'Buy Signal',
                        data: buy,
                        borderColor: 'green',
                        backgroundColor: 'rgba(0, 255, 0, 0.2)',
                        fill: false,
                        pointStyle: 'circle',
                        pointRadius: 7,
                        pointBackgroundColor: 'green',
                        borderWidth: 0,
                    },
                    {
                        label: 'Sell Signal',
                        data: sell,
                        borderColor: 'red',
                        backgroundColor: 'rgba(255, 0, 0, 0.2)',
                        fill: false,
                        pointStyle: 'circle',
                        pointRadius: 7,
                        pointBackgroundColor: 'red',
                        borderWidth: 0,
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Stock Price with Buy/Sell Signals'
                    },
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    x: {
                        type: 'category',
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Price'
                        }
                    }
                }
            }
        });
    }
</script>
</body>
</html>






